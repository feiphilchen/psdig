#!/usr/bin/env python3
import os
import sys
import time
import click
import curses
import logging
import re
import traceback
from curses import wrapper
from psdig import PsWatch,syscall_trace,event_trace,uprobe_trace
import signal

pswatch=None

def watch_interrupt(sig, frame):
    pswatch.stop()

def watch_start(stdscr, pid, uid, output, log, trace_def):
    stdscr.clear()
    stdscr.refresh()
    global pswatch
    pswatch = PsWatch(stdscr, pid_filter=pid, uid_filter=uid, \
       event_file=output, log_file=log, trace_def=trace_def)
    signal.signal(signal.SIGINT, watch_interrupt)
    try:
        pswatch.run()
    except:
        pass
    finally:
        pswatch.stop()

def event_load(stdscr, input_file, log):
    stdscr.clear()
    stdscr.refresh()
    pswatch = PsWatch(stdscr, load_from=input_file, log_file=log)
    try:
        pswatch.run()
    except:
        pass
    finally:
        pswatch.stop()

@click.command()
@click.option('--pid', '-p', type=int, multiple=True, help='Pid filter')
@click.option('--uid', '-u', type=int, multiple=True, help='Uid filter')
@click.option('--output', '-o', help='Save traces to the file')
@click.option('--log', '-l', help='Log all messages to logfile')
@click.option('--trace-conf', '-t', help='Trace definitions')
def watch(pid, uid, output, log, trace_conf):
    """Watch process traces and save to file"""
    wrapper(watch_start, pid, uid, output, log, trace_conf)

@click.command()
@click.option('--input', '-i', required=True, help='Load events from the file')
@click.option('--log', '-l', help='Log all messages to logfile')
def load(input, log):
    """Load traces from file"""
    wrapper(event_load,  input, log)
    pass

@click.group()
def trace():
    """Trace with specified formats"""
    pass

@click.group()
def cli():
    """Collect process syscall/tracepoint/uprobe traces"""
    pass

cli.add_command(watch, 'watch')
cli.add_command(load,'load')
cli.add_command(trace,'trace')
trace.add_command(syscall_trace, 'syscall')
trace.add_command(event_trace, 'event')
trace.add_command(uprobe_trace, 'uprobe')
if __name__ == '__main__':
    cli()

